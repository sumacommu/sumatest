<!DOCTYPE html>
<html>
<head>
  <title>スマブラマッチング</title>
  <style>
    .popup { 
      display: none; 
      position: fixed; 
      top: 20%; 
      left: 20%; 
      width: 60%; 
      height: 60%; 
      background: white; 
      border: none;
      overflow: auto; 
    }
    .popup img { 
      width: 64px; 
      height: 64px; 
      margin: 5px; 
    }
    .section { 
      margin: 20px 0; 
    }
    #miiInput { 
      display: none; 
    }
    .char-btn { 
      opacity: 0.3; 
      transition: opacity 0.3s; 
      border: none;
      background: none;
      padding: 0;
    }
    .char-btn.selected { 
      opacity: 1; 
    }
    .stage-btn { 
      opacity: 0.3; 
      transition: opacity 0.3s; 
      border: none;
      background: none;
      padding: 0;
    }
    .stage-btn.selected { 
      opacity: 1; 
    }
    button:not(.char-btn):not(.stage-btn) { 
      opacity: 1 !important; 
    }
    a { 
      display: block; 
      margin: 10px; 
    }
  </style>
</head>
<body>
  <h1>スマブラマッチング</h1>
  <p><a href="/api/solo">タイマン用</a></p>
  <p><a href="/api/team">チーム用</a></p>
  <p><a href="/api/auth/google?redirect=/api/" id="loginLink">Googleでログイン</a></p>
  <p><a href="/api/logout" id="logoutLink" style="display: none;">ログアウト</a></p>
  <p id="userPageLink" style="display: none;"><a href="#" id="userPage">マイページ</a></p>
  <div id="charSelected"></div>
  <div id="charPopup" class="popup">
    <!-- キャラクターボタンは動的に生成可能 -->
  </div>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script>
    var firebaseConfig = {
      apiKey: "${process.env.FIREBASE_API_KEY}",
      authDomain: "${process.env.FIREBASE_AUTH_DOMAIN}",
      projectId: "${process.env.FIREBASE_PROJECT_ID}",
      storageBucket: "${process.env.FIREBASE_STORAGE_BUCKET}",
      messagingSenderId: "${process.env.FIREBASE_MESSAGING_SENDER_ID}",
      appId: "${process.env.FIREBASE_APP_ID}",
      measurementId: "${process.env.FIREBASE_MEASUREMENT_ID}"
    };
    firebase.initializeApp(firebaseConfig);

    let selectedChar = null;

    function selectCharacter(id, name) {
      selectedChar = id;
      document.getElementById('charSelected').innerHTML = '<img src="/characters/' + id + '.png" width="64" height="64">';
      document.getElementById('charPopup').style.display = 'none';

      document.querySelectorAll('.char-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.id === id);
      });
    }

    document.querySelector('button[onclick*="charPopup"]')?.addEventListener('click', () => {
      document.getElementById('charPopup').style.display = 'block';
    });

    firebase.auth().onAuthStateChanged(user => {
      const loginLink = document.getElementById('loginLink');
      const logoutLink = document.getElementById('logoutLink');
      const userPageLink = document.getElementById('userPageLink');
      const userPage = document.getElementById('userPage');

      if (user) {
        loginLink.style.display = 'none';
        logoutLink.style.display = 'block';
        userPageLink.style.display = 'block';
        userPage.href = `/api/user/${user.uid}`;
        userPage.textContent = `${user.displayName || 'ユーザー'}のマイページ`;
      } else {
        loginLink.style.display = 'block';
        logoutLink.style.display = 'none';
        userPageLink.style.display = 'none';
      }
    });
  </script>
</body>
</html>